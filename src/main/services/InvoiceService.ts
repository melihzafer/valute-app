// src/main/services/InvoiceService.ts\n\nimport { v4 as uuidv4 } from \'uuid\';\nimport { dialog } from \'electron\';\nimport db from \'../db/store\';\nimport type { Invoice, Log } from \'../shared/types\';\nimport { InvoiceSchema } from \'../shared/schemas\';\nimport { getLogsByDateRange } from \'./LogService\'; // Import LogService to fetch logs\n\n// --- Invoice Service ---\n\nexport async function generateAndSaveInvoice(projectId: string, startDate: Date, endDate: Date): Promise<Invoice> {\n  await db.read();\n\n  // Fetch logs for the specified date range and project\n  const relevantLogs = await getLogsByDateRange(startDate, endDate) as Log[];\n  const projectLogs = relevantLogs.filter(log => log.projectId === projectId);\n\n  if (projectLogs.length === 0) {\n    throw new Error(\'No logs found for the specified project and date range.\');\n  }\n\n  // Calculate totals\n  let totalHours = 0;\n  projectLogs.forEach(log => {\n    totalHours += log.accumulatedTime;\n  });\n\n  // Fetch project details to get hourly rate and currency\n  const project = db.data.projects.find(p => p.id === projectId);\n  if (!project) {\n    throw new Error(`Project with id ${projectId} not found.`);\n  }\n\n  const totalAmount = (totalHours / 3600) * project.hourlyRate; // Assuming accumulatedTime is in seconds\n\n  // Create Invoice object\n  const newInvoiceData: Omit<Invoice, \'id\'> = {\n    projectId: projectId,\n    issueDate: new Date(),\n    dueDate: new Date(endDate.getTime() + 30 * 24 * 60 * 60 * 1000), // 30 days from endDate\n    logs: projectLogs,\n    totalHours: totalHours,\n    totalAmount: totalAmount,\n    currency: project.currency,\n    status: \'draft\', // Initial status\n  };\n\n  // Validate the invoice data using Zod schema\n  const validatedInvoiceData = InvoiceSchema.omit({ id: true }).parse(newInvoiceData);\n\n  const newInvoice: Invoice = {\n    id: uuidv4(),\n    ...validatedInvoiceData,\n  };\n\n  db.data.invoices.push(newInvoice);\n  await db.write();\n\n  // Trigger Save Dialog via IPC (this part is handled in handlers.ts)\n  // For now, we just return the created invoice object\n  console.log(\`Invoice generated: ${newInvoice.id}\`);\n\n  return newInvoice;\n}\n